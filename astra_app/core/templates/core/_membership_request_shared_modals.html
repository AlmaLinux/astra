{% comment %}
Shared modals for membership request actions (approve, reject, RFI, ignore).

Include this template ONCE per page that lists or displays membership requests,
instead of creating one modal per request row.  Buttons in
_membership_request_actions_inner.html carry per-request data via data-*
attributes; the script at the bottom copies them into the modal before it opens.
{% endcomment %}
{% load core_dict %}

{# ── Approve (confirm) ─────────────────────────────────────────────── #}
<div class="modal fade" id="shared-approve-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document" style="text-align: left;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" title="Close dialog">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <span class="js-body-prefix"></span> <strong class="js-body-emphasis"></strong><span class="js-body-suffix"></span>
        </div>
        <form method="post" action="" class="m-0">
          {% csrf_token %}
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Cancel" title="Close dialog without applying changes">Cancel</button>
            <button type="submit" class="btn btn-outline-success" name="custom_email" value="1" title="Submit and send a custom email">Approve with Custom Email</button>
            <button type="submit" class="btn btn-success" title="Confirm and apply this action">Approve</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{# ── Reject (preset textarea) ──────────────────────────────────────── #}
{% make_presets "RFI unanswered" "We were unable to complete the approval process because we did not receive the additional information requested during our review." "Embargoed country" "This decision is due to legal requirements that currently prevent the AlmaLinux OS Foundation from approving applications from certain countries." as reject_presets %}
<div class="modal fade" id="shared-reject-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document" style="text-align: left;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" title="Close dialog">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="post" action="" novalidate>
          {% csrf_token %}
          <div class="form-group">
            <label for="shared-reject-preset">Quick responses</label>
            <select id="shared-reject-preset" class="form-control" data-preset-textarea-target="shared-reject-reason">
              <option value="">Choose a preset (optional)</option>
              {% for preset in reject_presets %}
                <option value="{{ preset.value }}">{{ preset.label }}</option>
              {% endfor %}
            </select>
            <div class="text-muted small mt-1">Selecting a preset will copy it into the box below. You can still edit it.</div>
          </div>
          <div class="form-group">
            <label for="shared-reject-reason">Rejection reason (optional):</label>
            <textarea id="shared-reject-reason" name="reason" class="form-control" rows="4"></textarea>
          </div>
          <div class="text-muted small mb-3">If filled in, this text will be included in the rejection email.</div>
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Cancel" title="Close dialog">Cancel</button>
            <button type="submit" class="btn btn-outline-danger" name="custom_email" value="1" title="Reject with Custom Email">Reject with Custom Email</button>
            <button type="submit" class="btn btn-danger" title="Reject">Reject</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{# ── RFI (preset textarea) ─────────────────────────────────────────── #}
{% make_presets "More details" "Please provide additional details about your involvement with the AlmaLinux community, including any contributions, participation, or other relevant activities." "Incomplete Mirror PR" "Please review the status of your mirror pull request and address any outstanding issues so we can continue our review." as rfi_presets %}
<div class="modal fade" id="shared-rfi-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document" style="text-align: left;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" title="Close dialog">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="post" action="" novalidate>
          {% csrf_token %}
          <div class="form-group">
            <label for="shared-rfi-preset">Quick responses</label>
            <select id="shared-rfi-preset" class="form-control" data-preset-textarea-target="shared-rfi-message">
              <option value="">Choose a preset (optional)</option>
              {% for preset in rfi_presets %}
                <option value="{{ preset.value }}">{{ preset.label }}</option>
              {% endfor %}
            </select>
            <div class="text-muted small mt-1">Selecting a preset will copy it into the box below. You can still edit it.</div>
          </div>
          <div class="form-group">
            <label for="shared-rfi-message">RFI message:</label>
            <textarea id="shared-rfi-message" name="rfi_message" class="form-control" rows="4" required></textarea>
          </div>
          <div class="text-muted small mb-3">This will email the requester and put the request on hold.</div>
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Cancel" title="Close dialog">Cancel</button>
            <button type="submit" class="btn btn-outline-primary" name="custom_email" value="1" title="Send with Custom Email">Send with Custom Email</button>
            <button type="submit" class="btn btn-primary" title="Send RFI">Send RFI</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{# ── Ignore (confirm) ──────────────────────────────────────────────── #}
<div class="modal fade" id="shared-ignore-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document" style="text-align: left;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" title="Close dialog">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <span class="js-body-prefix"></span> <strong class="js-body-emphasis"></strong><span class="js-body-suffix"></span>
        </div>
        <form method="post" action="" class="m-0">
          {% csrf_token %}
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Cancel" title="Close dialog without applying changes">Cancel</button>
            <button type="submit" class="btn btn-outline-secondary" title="Confirm and apply this action">Ignore</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{# ── Populate shared modals from trigger-button data attributes ──── #}
<script>
// Deferred until DOMContentLoaded so jQuery and Bootstrap (loaded at the
// bottom of base.html) are available when we bind show.bs.modal.
// Bootstrap 4 fires that event via jQuery only.
document.addEventListener('DOMContentLoaded', function () {
  function onModalShow(event) {
    var btn = event.relatedTarget;
    if (!btn) return;
    var modal = event.target;

    var title = btn.getAttribute('data-modal-title');
    if (title) {
      var titleEl = modal.querySelector('.modal-title');
      if (titleEl) titleEl.textContent = title;
    }

    var actionUrl = btn.getAttribute('data-action-url');
    if (actionUrl) {
      var form = modal.querySelector('form');
      if (form) form.setAttribute('action', actionUrl);
    }

    // Confirm-style body fragments (approve / ignore)
    var prefix = btn.getAttribute('data-body-prefix');
    var emphasis = btn.getAttribute('data-body-emphasis');
    var suffix = btn.getAttribute('data-body-suffix');
    var prefixEl = modal.querySelector('.js-body-prefix');
    var emphasisEl = modal.querySelector('.js-body-emphasis');
    var suffixEl = modal.querySelector('.js-body-suffix');
    if (prefixEl) prefixEl.textContent = prefix || '';
    if (emphasisEl) emphasisEl.textContent = emphasis || '';
    if (suffixEl) suffixEl.textContent = suffix || '';

    // Reset textarea and preset dropdown so previous values don't leak
    var textarea = modal.querySelector('textarea');
    if (textarea) textarea.value = '';
    var select = modal.querySelector('select');
    if (select) select.selectedIndex = 0;
  }

  var ids = ['shared-approve-modal', 'shared-reject-modal', 'shared-rfi-modal', 'shared-ignore-modal'];
  for (var i = 0; i < ids.length; i++) {
    var el = document.getElementById(ids[i]);
    if (el) {
      // jQuery event required by Bootstrap 4's modal plugin.
      // jQuery is guaranteed loaded by now (DOMContentLoaded).
      window.jQuery(el).on('show.bs.modal', onModalShow);
    }
  }

  // Preset dropdown → textarea: copy selected preset value into the target textarea
  document.addEventListener('change', function (event) {
    var target = event.target;
    if (!target || !target.matches || !target.matches('[data-preset-textarea-target]')) return;
    var textareaId = target.getAttribute('data-preset-textarea-target');
    if (!textareaId) return;
    var textarea = document.getElementById(textareaId);
    if (!textarea) return;
    textarea.value = target.value || '';
    textarea.focus();
  });
});
</script>
