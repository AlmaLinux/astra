{% extends 'core/base.html' %}

{% load core_membership_responses %}

{% block title %}
  {% if req %}
    Your Membership Request #{{ req.pk }}
  {% else %}
    Request Membership
  {% endif %}
{% endblock %}

{% block header %}
  {% if req %}
    <div class="d-flex align-items-center justify-content-between flex-wrap" style="gap: .5rem;">
      <h1 class="m-0">Your Membership Request #{{ req.pk }}</h1>
    </div>
  {% else %}
    <h1 class="m-0">Request Membership</h1>
  {% endif %}
{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-body">
      {% if req %}
        <dl class="row mb-0">
          <dt class="col-sm-3">Status</dt>
          <dd class="col-sm-9">{{ req.get_status_display }}</dd>

          <dt class="col-sm-3">Requested at</dt>
          <dd class="col-sm-9">{{ req.requested_at }}</dd>

          <dt class="col-sm-3">Type</dt>
          <dd class="col-sm-9">{{ req.membership_type.name }}</dd>

          {% if req.requested_organization_name %}
            <dt class="col-sm-3">Organization</dt>
            <dd class="col-sm-9">{{ req.requested_organization_name }}</dd>
          {% endif %}

          {% if req.on_hold_at %}
            <dt class="col-sm-3">On hold since</dt>
            <dd class="col-sm-9">{{ req.on_hold_at }}</dd>
          {% endif %}
        </dl>
        <hr>

        {% if req.status == 'on_hold' %}
          <div class="callout callout-danger">
            We sent you an email{% if user_email %} to <strong>{{ user_email }}</strong>{% endif %} asking for clarifications.
            Please update your request below and submit it to resume review.
          </div>
        {% endif %}
      {% endif %}

      <div class="mb-3 text-muted">
        Membership is subject to confirmation of eligibility.
        Your request will be reviewed by the Membership Committee.
      </div>

      {% if req %}
        {% if req.status == 'pending' or req.status == 'on_hold' %}
          <form id="membership-rescind-form" method="post" action="{% url 'membership-request-rescind' req.pk %}">
            {% csrf_token %}
          </form>
        {% endif %}
      {% endif %}

      <form
        id="membership-request-form"
        method="{% if not req or req.status == 'on_hold' %}post{% else %}get{% endif %}"
        {% include 'core/_form_validation_attrs.html' with form=form validation_hook='membership-mirror' %}
        {% if req %}data-membership-type="{{ req.membership_type.code }}" data-membership-category="{{ req.membership_type.category_id }}"{% endif %}
      >
        {% if not req or req.status == 'on_hold' %}
          {% csrf_token %}
        {% endif %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger" role="alert">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        {% if req %}
          {% for field in form %}
            {% include 'core/_form_field.html' %}
          {% endfor %}

        {% else %}
          {% with field=form.membership_type %}
            {% include 'core/_form_field.html' %}
          {% endwith %}

          <div id="questions-individual" class="mt-3">
            <h5>Individual Membership</h5>
            {% for field in form %}
              {% if field.name == 'q_contributions' %}
                {% include 'core/_form_field.html' %}
              {% endif %}
            {% endfor %}
          </div>

          <div id="questions-sponsorship" class="mt-3">
            <h5>Sponsorship</h5>
            {% for field in form %}
              {% if field.name == 'q_sponsorship_details' %}
                {% include 'core/_form_field.html' %}
              {% endif %}
            {% endfor %}
          </div>

          <div id="questions-mirror" class="mt-3">
            <h5>Mirror Membership</h5>
            {% for field in form %}
              {% if field.name|slice:':2' == 'q_' and field.name != 'q_contributions' and field.name != 'q_sponsorship_details' %}
                {% include 'core/_form_field.html' %}
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

        {% if not req or req.status == 'on_hold' %}
          <div class="mt-4 mb-3 text-muted">
            By clicking the "Submit request" button below, you acknowledge and agree that, when accepted by
            AlmaLinux OS Foundation, this application represents a binding contract between the parties
            and commits the applicant to comply with all the terms and conditions of AlmaLinux OS
            Foundation's Bylaws and such rules and policies as the Board of Directors and/or committees
            may from time to time adopt. Additionally, the applicant hereby acknowledges and consents to
            the terms set forth in the <a href="{% url 'privacy-policy' %}">AlmaLinux OS Foundation Privacy Policy</a>.
          </div>
        {% endif %}

        <div class="d-flex justify-content-between flex-wrap mt-3" style="gap: .5rem;">
          <a href="{{ cancel_url }}" class="btn btn-secondary" title="Return without changes">Cancel</a>

          {% if not req or req.status == 'on_hold' %}
            <button
              type="submit"
              class="btn btn-success"
              title="{% if req %}Submit updated request{% else %}Submit membership request{% endif %}"
            >Submit request</button>
          {% endif %}

          {% if req %}
            {% if req.status == 'pending' or req.status == 'on_hold' %}
              <button
                type="submit"
                form="membership-rescind-form"
                formnovalidate
                class="btn btn-outline-danger"
                title="Cancel your membership request"
              >Rescind request</button>
            {% endif %}
          {% endif %}
        </div>

      </form>
    </div>
  </div>

  <script>
    (function () {
      const form = document.getElementById('membership-request-form');
      const select = document.getElementById('id_membership_type');
      const individual = document.getElementById('questions-individual');
      const sponsorship = document.getElementById('questions-sponsorship');
      const mirror = document.getElementById('questions-mirror');

      const contributions = document.getElementById('id_q_contributions');
      const sponsorshipDetails = document.getElementById('id_q_sponsorship_details');
      const domain = document.getElementById('id_q_domain');
      const pullRequest = document.getElementById('id_q_pull_request');

      function membershipTypeCategory() {
        if (select) {
          const code = select.value || '';
          const rawMap = (select.dataset && select.dataset.categoryMap) ? select.dataset.categoryMap : '';
          if (rawMap) {
            try {
              const map = JSON.parse(rawMap);
              if (map && typeof map === 'object' && Object.prototype.hasOwnProperty.call(map, code)) {
                return map[code] || '';
              }
            } catch (e) {
              // Ignore parse failures and fall back to code-based handling.
            }
          }
          if (code === 'mirror') return 'mirror';
          return '';
        }

        const candidateForm = (sponsorshipDetails && sponsorshipDetails.form)
          ? sponsorshipDetails.form
          : ((domain && domain.form) ? domain.form : ((pullRequest && pullRequest.form) ? pullRequest.form : null));
        if (candidateForm && candidateForm.dataset && candidateForm.dataset.membershipCategory) {
          return candidateForm.dataset.membershipCategory;
        }
        return '';
      }

      function membershipTypeCode() {
        if (select) return select.value || '';
        const candidateForm = (sponsorshipDetails && sponsorshipDetails.form)
          ? sponsorshipDetails.form
          : ((domain && domain.form) ? domain.form : ((pullRequest && pullRequest.form) ? pullRequest.form : null));
        if (candidateForm && candidateForm.dataset && candidateForm.dataset.membershipType) return candidateForm.dataset.membershipType;
        return '';
      }

      function isHttpUrl(s) {
        try {
          const u = new URL(s);
          return (u.protocol === 'http:' || u.protocol === 'https:') && !!u.hostname;
        } catch (e) {
          return false;
        }
      }

      function isBareDomain(s) {
        // Minimal sanity check: no spaces, has at least one dot, and uses common hostname chars.
        if (!s) return false;
        if (/\s/.test(s)) return false;
        if (!s.includes('.')) return false;
        return /^[A-Za-z0-9.-]+$/.test(s);
      }

      function validateMirrorFields() {
        const category = membershipTypeCategory();
        if (category !== 'mirror') {
          if (domain) domain.setCustomValidity('');
          if (pullRequest) pullRequest.setCustomValidity('');
          return true;
        }

        let ok = true;

        if (domain) {
          const v = (domain.value || '').trim();
          if (!v) {
            domain.setCustomValidity('');
          } else if (v.includes('://')) {
            if (isHttpUrl(v)) {
              domain.setCustomValidity('');
            } else {
              domain.setCustomValidity('Enter a valid http(s) URL.');
              ok = false;
            }
          } else {
            if (isBareDomain(v)) {
              domain.setCustomValidity('');
            } else {
              domain.setCustomValidity('Enter a valid domain name.');
              ok = false;
            }
          }
        }

        if (pullRequest) {
          const v = (pullRequest.value || '').trim();
          if (!v) {
            pullRequest.setCustomValidity('');
          } else if (isHttpUrl(v)) {
            pullRequest.setCustomValidity('');
          } else {
            pullRequest.setCustomValidity('Enter a valid http(s) URL.');
            ok = false;
          }
        }

        return ok;
      }

      function update() {
        if (select && individual && mirror && sponsorship) {
          const category = membershipTypeCategory();
          const code = membershipTypeCode();
          const isMirror = category === 'mirror' || code === 'mirror';
          const isSponsorship = category === 'sponsorship';
          const isIndividual = category === 'individual' || (!category && !isMirror);

          individual.style.display = isIndividual ? '' : 'none';
          sponsorship.style.display = isSponsorship ? '' : 'none';
          mirror.style.display = isMirror ? '' : 'none';

          if (contributions) contributions.required = isIndividual;
          if (sponsorshipDetails) sponsorshipDetails.required = isSponsorship;
          if (domain) domain.required = isMirror;
          if (pullRequest) pullRequest.required = isMirror;
        }

        validateMirrorFields();
      }

      if (form) {
        form.addEventListener('astra:validate-form', function () {
          update();
        });
      }
      update();
    })();
  </script>
{% endblock %}
