{% extends 'core/base.html' %}
{% load static %}

{% block title %}{% if is_create %}Create organization{% else %}Edit {{ organization.name }}{% endif %}{% endblock %}

{% block header %}
  <h1 class="h3">{% if is_create %}Create organization{% else %}Edit {{ organization.name }}{% endif %}</h1>
{% endblock %}

{% block extra_head %}
  {% if show_representatives %}
    <link rel="stylesheet" href="{% static 'admin/css/vendor/select2/select2.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/select2_overrides.css' %}">
  {% endif %}
{% endblock %}

{% block content %}
  <div class="organization-page">
    <form method="post" enctype="multipart/form-data" {% include 'core/_form_validation_attrs.html' with form=form %}>
      {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}

      {% if is_create %}
        <div class="alert alert-info">
          Create an organization profile only if you are an employee or authorized representative of the organization applying to sponsor AlmaLinux.
          You will be listed as the initial representative.
        </div>
      {% endif %}

      <div class="card">
      <div class="card-header">
        <h3 class="card-title">Branding</h3>
      </div>
      <div class="card-body">
        {% include 'core/_form_field.html' with field=form.name %}

        {% include 'core/_form_field.html' with field=form.website_logo %}

        {% include 'core/_form_field.html' with field=form.website %}

        {% include 'core/_form_field.html' with field=form.logo %}
          {% if not is_create and organization and organization.logo %}
            <div class="mt-2">
              <img src="{{ organization.logo.url }}" alt="{{ organization.name }} logo" style="max-height: 120px;" />
            </div>
            <div class="mt-2">
              <a href="{{ organization.logo.url }}" rel="noopener noreferrer">View current uploaded logo</a>
            </div>
          {% endif %}
      </div>
    </div>

      <div class="card">
      <div class="card-header">
        <h3 class="card-title">Address</h3>
      </div>
      <div class="card-body">
        {% include 'core/_form_field.html' with field=form.street %}
        {% include 'core/_form_field.html' with field=form.city %}
        {% include 'core/_form_field.html' with field=form.state %}
        {% include 'core/_form_field.html' with field=form.postal_code %}
        {% include 'core/_form_field.html' with field=form.country_code %}
      </div>
    </div>

    {% with selected_contact=selected_contact|default:"" %}
      {% if selected_contact %}
        {% if selected_contact == "representative" and not show_representatives %}
          {% with active_contact="business" %}
            {% include "core/_organization_contacts_tabs.html" %}
          {% endwith %}
        {% else %}
          {% with active_contact=selected_contact %}
            {% include "core/_organization_contacts_tabs.html" %}
          {% endwith %}
        {% endif %}
      {% else %}
        {% if show_representatives %}
          {% with active_contact="representative" %}
            {% include "core/_organization_contacts_tabs.html" %}
          {% endwith %}
        {% else %}
          {% with active_contact="business" %}
            {% include "core/_organization_contacts_tabs.html" %}
          {% endwith %}
        {% endif %}
      {% endif %}
    {% endwith %}

      <div class="card organization-form-footer">
        <div class="card-body">
          <div class="mb-0 text-muted">
            By clicking "{% if is_create %}Create{% else %}Save{% endif %}", you acknowledge and agree that, when accepted by AlmaLinux OS Foundation, this application represents a binding
            contract between the parties and commits the applicant to comply with all the terms and conditions of AlmaLinux OS Foundation's Bylaws and such rules and policies as the Board of Directors
            and/or committees may from time to time adopt. Additionally, the applicant hereby acknowledges and consents to the terms set forth in the
            <a href="{% url 'privacy-policy' %}">AlmaLinux OS Foundation Privacy Policy</a>.
          </div>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center flex-wrap" style="gap: .75rem;">
          <div>
            {% if is_create %}
              <a class="btn btn-secondary" href="{{ cancel_url }}" title="Cancel and discard changes">Cancel</a>
            {% else %}
              <a class="btn btn-secondary" href="{% url 'organization-detail' organization.pk %}" title="Cancel and discard changes">Cancel</a>
            {% endif %}
          </div>
          <div>
            <button type="submit" class="btn btn-success" title="{% if is_create %}Create organization{% else %}Save organization changes{% endif %}">{% if is_create %}Create{% else %}Save{% endif %}</button>
          </div>
        </div>
      </div>
    </form>
  </div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  {% if show_representatives %}
    <script src="{% static 'admin/js/vendor/select2/select2.full.js' %}"></script>
    <script>
      (function () {
        const $ = window.jQuery;
        if (!$ || !$.fn || !$.fn.select2) return;

        $('select.alx-select2').each(function () {
          const $select = $(this);
          if ($select.data('alx-select2-initialized')) return;
          $select.data('alx-select2-initialized', true);

          const ajaxUrl = $select.data('ajax-url') || $select.attr('data-ajax-url') || '';
          $select.select2({
            width: '100%',
            placeholder: $select.data('placeholder') || 'Search usersâ€¦',
            allowClear: true,
            ajax: ajaxUrl ? {
              url: ajaxUrl,
              dataType: 'json',
              delay: 200,
              data: function (params) {
                return { q: params.term || '' };
              },
              processResults: function (data) {
                return { results: Array.isArray(data.results) ? data.results : [] };
              },
              cache: true,
            } : undefined,
            minimumInputLength: 1,
          });
        });
      })();
    </script>
  {% endif %}
  <script>
    (function () {
      'use strict';
      var tabsEl = document.getElementById('contacts-tabs');
      if (!tabsEl) return;
      var formEl = tabsEl.closest('form');
      if (!formEl) return;

      function refreshTabErrors() {
        var tabContent = document.getElementById('contacts-tab-content');
        if (!tabContent) {
          return { firstErrorLink: null, firstErrorField: null };
        }
        var panes = tabContent.querySelectorAll('.tab-pane');
        var firstErrorLink = null;
        var firstErrorField = null;
        for (var i = 0; i < panes.length; i++) {
          var invalidField = panes[i].querySelector(':invalid');
          var hasError = !!invalidField;
          var link = tabsEl.querySelector('[href="#' + panes[i].id + '"]');
          if (hasError && !firstErrorField) {
            firstErrorField = invalidField;
          }
          if (link) {
            link.classList.toggle('alx-tab-error', hasError);
            if (hasError && !firstErrorLink) {
              firstErrorLink = link;
            }
          }
        }
        return { firstErrorLink: firstErrorLink, firstErrorField: firstErrorField };
      }

      function focusInvalidField(field) {
        if (!field) return;

        if (field.classList && field.classList.contains('select2-hidden-accessible')) {
          var adjacentContainer = field.nextElementSibling;
          var selection = null;
          if (adjacentContainer) {
            if (adjacentContainer.classList.contains('select2-selection')) {
              selection = adjacentContainer;
            } else {
              selection = adjacentContainer.querySelector('.select2-selection');
            }
          }
          if (!selection && field.parentElement) {
            selection = field.parentElement.querySelector('.select2-selection');
          }

          var scrollTarget = selection || adjacentContainer || field;
          if (scrollTarget && typeof scrollTarget.scrollIntoView === 'function') {
            scrollTarget.scrollIntoView({ block: 'center' });
          }

          var jq = window.jQuery;
          if (jq && jq.fn && jq.fn.select2) {
            jq(field).select2('open');
            return;
          }
          if (selection && typeof selection.focus === 'function') {
            selection.focus();
            return;
          }
        }

        if (typeof field.scrollIntoView === 'function') {
          field.scrollIntoView({ block: 'center' });
        }

        if (typeof field.focus === 'function') {
          field.focus();
        }
      }

      // The shared validator uses stopPropagation(), which only stops bubbling.
      // It does not call stopImmediatePropagation(), so this submit listener on
      // the same form still runs after was-validated is applied.
      formEl.addEventListener('submit', function () {
        var tabErrors = refreshTabErrors();
        var firstErrorLink = tabErrors.firstErrorLink;
        var firstErrorField = tabErrors.firstErrorField;
        if (firstErrorLink) {
          var jq = window.jQuery;
          if (firstErrorLink.classList.contains('active')) {
            focusInvalidField(firstErrorField);
            return;
          }

          if (jq && jq.fn && jq.fn.tab) {
            jq(firstErrorLink).one('shown.bs.tab', function () {
              focusInvalidField(firstErrorField);
            });
            jq(firstErrorLink).tab('show');
          } else {
            firstErrorLink.click();
            setTimeout(function () {
              focusInvalidField(firstErrorField);
            }, 0);
          }
        }
      }, false);
    })();
  </script>
{% endblock %}
