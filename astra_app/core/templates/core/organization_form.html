{% extends 'core/base.html' %}
{% load static %}

{% block title %}{% if is_create %}Create organization{% else %}Edit {{ organization.name }}{% endif %}{% endblock %}

{% block header %}
  <h1 class="h3">{% if is_create %}Create organization{% else %}Edit {{ organization.name }}{% endif %}</h1>
{% endblock %}

{% block extra_head %}
  {% if show_representatives %}
    <link rel="stylesheet" href="{% static 'admin/css/vendor/select2/select2.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/select2_overrides.css' %}">
  {% endif %}
{% endblock %}

{% block content %}
  <div class="organization-page">
    <form method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}

      {% if is_create %}
        <div class="alert alert-info">
          Create an organization profile only if you are an employee or authorized representative of the organization applying to sponsor AlmaLinux.
          You will be listed as the initial representative.
        </div>
      {% endif %}

    {% with selected_contact=selected_contact|default:"" %}
      {% if selected_contact %}
        {% if selected_contact == "representative" and not show_representatives %}
          {% with active_contact="business" %}
            {% include "core/_organization_contacts_tabs.html" %}
          {% endwith %}
        {% else %}
          {% with active_contact=selected_contact %}
            {% include "core/_organization_contacts_tabs.html" %}
          {% endwith %}
        {% endif %}
      {% else %}
        {% if show_representatives %}
          {% with active_contact="representative" %}
            {% include "core/_organization_contacts_tabs.html" %}
          {% endwith %}
        {% else %}
          {% with active_contact="business" %}
            {% include "core/_organization_contacts_tabs.html" %}
          {% endwith %}
        {% endif %}
      {% endif %}
    {% endwith %}

      <div class="card">
      <div class="card-header">
        <h3 class="card-title">Branding</h3>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="{{ form.name.id_for_label }}">{{ form.name.label }} <span class="text-danger">(required)</span></label>
          {{ form.name }}
          {% if form.name.errors %}<div class="text-danger">{{ form.name.errors }}</div>{% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.website_logo.id_for_label }}">{{ form.website_logo.label }} <span class="text-danger">(required)</span></label>
          {{ form.website_logo }}
          {% if form.website_logo.help_text %}<small class="form-text text-muted">{{ form.website_logo.help_text }}</small>{% endif %}
          {% if form.website_logo.errors %}<div class="text-danger">{{ form.website_logo.errors }}</div>{% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.website.id_for_label }}">{{ form.website.label }} <span class="text-danger">(required)</span></label>
          {{ form.website }}
          {% if form.website.help_text %}<small class="form-text text-muted">{{ form.website.help_text }}</small>{% endif %}
          {% if form.website.errors %}<div class="text-danger">{{ form.website.errors }}</div>{% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.logo.id_for_label }}">{{ form.logo.label }}</label>
          {{ form.logo }}
          {% if form.logo.errors %}<div class="text-danger">{{ form.logo.errors }}</div>{% endif %}
          {% if not is_create and organization and organization.logo %}
            <div class="mt-2">
              <img src="{{ organization.logo.url }}" alt="{{ organization.name }} logo" style="max-height: 120px;" />
            </div>
            <div class="mt-2">
              <a href="{{ organization.logo.url }}" rel="noopener noreferrer">View current uploaded logo</a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

      <div class="card organization-form-footer">
        <div class="card-body">
          <div class="mb-0 text-muted">
            By clicking "{% if is_create %}Create{% else %}Save{% endif %}", you acknowledge and agree that, when accepted by AlmaLinux OS Foundation, this application represents a binding
            contract between the parties and commits the applicant to comply with all the terms and conditions of AlmaLinux OS Foundation's Bylaws and such rules and policies as the Board of Directors
            and/or committees may from time to time adopt. Additionally, the applicant hereby acknowledges and consents to the terms set forth in the
            <a href="{% url 'privacy-policy' %}">AlmaLinux OS Foundation Privacy Policy</a>.
          </div>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center flex-wrap" style="gap: .75rem;">
          <div>
            {% if is_create %}
              <a class="btn btn-secondary" href="{{ cancel_url }}" title="Cancel and discard changes">Cancel</a>
            {% else %}
              <a class="btn btn-secondary" href="{% url 'organization-detail' organization.pk %}" title="Cancel and discard changes">Cancel</a>
            {% endif %}
          </div>
          <div>
            <button type="submit" class="btn btn-success" title="{% if is_create %}Create organization{% else %}Save organization changes{% endif %}">{% if is_create %}Create{% else %}Save{% endif %}</button>
          </div>
        </div>
      </div>
    </form>
  </div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  {% if show_representatives %}
    <script src="{% static 'admin/js/vendor/select2/select2.full.js' %}"></script>
    <script>
      (function () {
        const $ = window.jQuery;
        if (!$ || !$.fn || !$.fn.select2) return;

        $('select.alx-select2').each(function () {
          const $select = $(this);
          if ($select.data('alx-select2-initialized')) return;
          $select.data('alx-select2-initialized', true);

          const ajaxUrl = $select.data('ajax-url') || $select.attr('data-ajax-url') || '';
          $select.select2({
            width: '100%',
            placeholder: $select.data('placeholder') || 'Search usersâ€¦',
            allowClear: true,
            ajax: ajaxUrl ? {
              url: ajaxUrl,
              dataType: 'json',
              delay: 200,
              data: function (params) {
                return { q: params.term || '' };
              },
              processResults: function (data) {
                return { results: Array.isArray(data.results) ? data.results : [] };
              },
              cache: true,
            } : undefined,
            minimumInputLength: 1,
          });
        });
      })();
    </script>
  {% endif %}
{% endblock %}
