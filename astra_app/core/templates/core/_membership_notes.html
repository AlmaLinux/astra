{% load static %}
{% load avatar_tags %}
{% load tz %}

  <link rel="stylesheet" href="{% static 'core/css/membership_notes.css' %}" data-membership-notes-css>

  <div
    id="membership-notes-container-{{ membership_request.pk }}"
    data-membership-notes-container="{{ membership_request.pk }}"
    data-membership-notes-default-open="{% if compact %}0{% else %}1{% endif %}"
  >

    <div
      id="membership-notes-card-{{ membership_request.pk }}"
      class="card card-primary card-outline direct-chat direct-chat-primary mb-0{% if compact %} collapsed-card{% endif %}"
      data-membership-notes-card="{{ membership_request.pk }}"
    >
      <div
        class="card-header{% if compact %} membership-notes-header-compact{% endif %}"
        data-membership-notes-header="{{ membership_request.pk }}"
        role="button"
        tabindex="0"
        aria-label="Toggle membership notes"
        style="cursor: pointer;"
      >
        <h3
          class="card-title membership-notes-title {% if compact %}text-sm text-truncate{% endif %}"
        >
          Membership Committee Notes
        </h3>
        <div class="card-tools">
          <span
            data-toggle="tooltip"
            title="{{ note_count }} Messages"
            class="badge badge-primary"
            data-membership-notes-count="{{ membership_request.pk }}"
          >{{ note_count }}</span>
          <span class="badge badge-success" title="Approvals" data-membership-notes-approvals="{{ membership_request.pk }}">
            <i class="fas fa-thumbs-up"></i> {{ approvals }}
          </span>
          <span class="badge badge-danger" title="Disapprovals" data-membership-notes-disapprovals="{{ membership_request.pk }}">
            <i class="fas fa-thumbs-down"></i> {{ disapprovals }}
          </span>
          <button
            type="button"
            class="btn btn-tool"
            data-card-widget="collapse"
            aria-label="Collapse"
            title="Expand or collapse notes"
            data-membership-notes-collapse="{{ membership_request.pk }}"
          >
            <i class="fas {% if compact %}fa-plus{% else %}fa-minus{% endif %}"></i>
          </button>
        </div>
      </div>

      <div class="card-body">
        <div
          class="direct-chat-messages"
          data-membership-notes-messages="{{ membership_request.pk }}"
          {% if compact %} style="max-height: 260px;"{% else %} style="height: 400px;"{% endif %}
        >
          {% for group in groups %}
            {% with entry=group.header_entry %}
              <div
                class="direct-chat-msg {% if not forloop.last %}mb-3{% endif %} {% if group.is_self %} right{% endif %}"
                data-membership-notes-group-username="{{ entry.note.username }}"
              >
                <div class="direct-chat-infos clearfix">
                  {% if group.is_self %}
                    <span class="direct-chat-name float-right">{{ entry.display_username|default:entry.note.username }}</span>
                    <span class="direct-chat-timestamp float-left">
                      {{ entry.note.timestamp|localtime|date:"DATETIME_FORMAT" }}
                      {% if entry.membership_request_id and entry.membership_request_url %}
                        <a href="{{ entry.membership_request_url }}" class="text-muted ml-1">(req. #{{ entry.membership_request_id }})</a>
                      {% endif %}
                    </span>
                  {% else %}
                    <span class="direct-chat-name float-left">{{ entry.display_username|default:entry.note.username }}</span>
                    <span class="direct-chat-timestamp float-right">
                      {% if entry.membership_request_id and entry.membership_request_url %}
                        <a href="{{ entry.membership_request_url }}" class="text-muted mr-1">(req. #{{ entry.membership_request_id }})</a>
                      {% endif %}
                      {{ entry.note.timestamp|localtime|date:"DATETIME_FORMAT" }}
                    </span>
                  {% endif %}
                </div>

                {% if entry.is_custos %}
                  <img
                    class="direct-chat-img img-circle"
                    src="{% static 'core/images/almalinux-logo.svg' %}"
                    alt="Astra Custodia"
                    style="object-fit: cover; background: #fff;"
                  >
                {% elif entry.avatar_user %}
                  {% avatar entry.avatar_user 40 class="direct-chat-img img-circle" style="object-fit:cover;" alt="Avatar" %}
                {% else %}
                  <img class="direct-chat-img" src="{% static 'core/images/almalinux-logo.svg' %}" alt="user image">
                {% endif %}

                <div class="membership-notes-bubbles">
                  {% for entry in group.entries %}
                    {% if entry.kind == 'action' %}
                      <div
                        class="direct-chat-text bg-light membership-notes-bubble"
                        style="{{ entry.bubble_style }} border: 1px dashed rgba(0,0,0,0.15);"
                      >
                        <i class="fas {{ entry.icon|default:"fa-bolt" }} mr-1"></i> {{ entry.label }}
                        {% if entry.email_modal_id %}
                          <button
                            type="button"
                            class="btn btn-link btn-sm p-0 ml-2"
                            data-toggle="modal"
                            data-target="#{{ entry.email_modal_id }}"
                            aria-label="View email"
                          >View email</button>
                        {% endif %}
                      </div>
                    {% else %}
                      {% if not entry.is_self and entry.bubble_style %}
                        <div
                          class="direct-chat-text membership-notes-bubble"
                          style="{{ entry.bubble_style }}{% if entry.is_custos %} border: 1px dashed rgba(0,0,0,0.15);{% endif %}"
                        >
                          {{ entry.note.content }}
                        </div>
                      {% else %}
                        <div class="direct-chat-text{% if entry.is_self %} membership-notes-self-bubble{% endif %}">
                          {{ entry.note.content }}
                        </div>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endwith %}
          {% empty %}
            <div class="text-muted small">No notes yet.</div>
          {% endfor %}
        </div>
      </div>

      <div class="card-footer">
        <div
          id="membership-notes-error-{{ membership_request.pk }}"
          class="alert alert-danger py-2 px-3 mb-2 d-none"
          role="alert"
          aria-live="polite"
        >
          <div class="d-flex align-items-start justify-content-between" style="gap: .75rem;">
            <div id="membership-notes-error-text-{{ membership_request.pk }}"></div>
            <button
              type="button"
              class="close"
              aria-label="Dismiss"
              title="Dismiss error message"
              data-membership-notes-error-close="{{ membership_request.pk }}"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        </div>
        <form
          id="membership-notes-form-{{ membership_request.pk }}"
          method="post"
          action="{{ post_url }}"
          data-membership-notes-form="{{ membership_request.pk }}"
        >
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ next_url }}">
          {% if aggregate_target_type and aggregate_target %}
            <input type="hidden" name="aggregate_target_type" value="{{ aggregate_target_type }}">
            <input type="hidden" name="aggregate_target" value="{{ aggregate_target }}">
          {% endif %}
          <input type="hidden" name="note_action" value="message">
          <div class="input-group">
            <textarea
              id="membership-notes-message-{{ membership_request.pk }}"
              name="message"
              placeholder="Type a note..."
              class="form-control"
              rows="2"
            ></textarea>
            <div class="input-group-append">
              {% if compact %}
                <button
                  type="submit"
                  class="btn btn-light border"
                  title="Send (Ctrl+Enter)"
                  aria-label="Send note"
                >
                  <i class="fas fa-paper-plane"></i>
                </button>
              {% else %}
                <div class="btn-group" role="group" aria-label="Note actions">
                  <button
                    type="submit"
                    class="btn btn-light border"
                    title="Send (Ctrl+Enter)"
                    aria-label="Send note"
                  >
                    <i class="fas fa-paper-plane mr-1"></i> Send
                  </button>
                  {% if can_vote %}
                    <button
                      type="button"
                      class="btn btn-light border"
                      data-note-action="vote_approve"
                      title="Vote to approve"
                      aria-label="Vote approve"
                    >
                      <i class="fas fa-thumbs-up text-success"></i>
                    </button>
                    <button
                      type="button"
                      class="btn btn-light border"
                      data-note-action="vote_disapprove"
                      title="Vote to disapprove"
                      aria-label="Vote disapprove"
                    >
                      <i class="fas fa-thumbs-down text-danger"></i>
                    </button>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>

            {% if compact and can_vote %}
              <div class="d-flex w-100 mt-1" role="group" aria-label="Vote actions">
                <button
                  type="button"
                  class="btn btn-light border btn-sm flex-fill py-1"
                  data-note-action="vote_approve"
                  title="Vote to approve"
                  aria-label="Vote approve"
                >
                  <i class="fas fa-thumbs-up text-success"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-light border btn-sm flex-fill py-1"
                  data-note-action="vote_disapprove"
                  title="Vote to disapprove"
                  aria-label="Vote disapprove"
                >
                  <i class="fas fa-thumbs-down text-danger"></i>
                </button>
              </div>
            {% endif %}
        </form>
      </div>
    </div>

    {% if email_modals %}
      {% for modal in email_modals %}
        {% include "core/_membership_email_modal.html" with modal=modal %}
      {% endfor %}
    {% endif %}

    <script src="{% static 'core/js/membership_notes.js' %}"></script>
    <script>AstraMembershipNotes.init('{{ membership_request.pk|escapejs }}');</script>
  </div>
