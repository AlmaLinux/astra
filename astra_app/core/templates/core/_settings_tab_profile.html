{% load static %}

<form method="post" novalidate class="m-0" data-settings-save-all="1">
	{% csrf_token %}
	<input type="hidden" name="tab" value="profile" />

	{% if profile_form.non_field_errors %}
		<div class="alert alert-danger">{{ profile_form.non_field_errors }}</div>
	{% endif %}

	<div class="settings-form">
		<div class="settings-profile-hero mb-4">
			<div class="d-flex align-items-center">
				<div class="settings-profile-avatar">
					<img src="{{ avatar_url }}" class="img-fluid img-circle" style="width:96px;height:96px;object-fit:cover;" alt="Avatar" />
				</div>
				<div class="ml-3">
					<button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#avatar-modal" title="Update your avatar">Change avatar</button>
					<div class="mt-1">
						<small class="text-muted">Upload a local avatar, or keep using your current avatar provider.</small>
					</div>
				</div>
			</div>
		</div>

		<div class="form-row">
			<div class="form-group col-md-6">
				{{ profile_form.givenname.label_tag }}
				{{ profile_form.givenname }}
				{% if profile_form.givenname.errors %}<div class="text-danger">{{ profile_form.givenname.errors }}</div>{% endif %}
			</div>
			<div class="form-group col-md-6">
				{{ profile_form.sn.label_tag }}
				{{ profile_form.sn }}
				{% if profile_form.sn.errors %}<div class="text-danger">{{ profile_form.sn.errors }}</div>{% endif %}
			</div>
		</div>

		<div class="form-group">
			{{ profile_form.fasPronoun.label_tag }}
			{{ profile_form.fasPronoun }}
			{% if profile_form.fasPronoun.errors %}<div class="text-danger">{{ profile_form.fasPronoun.errors }}</div>{% endif %}
			{% if profile_form.fasPronoun.help_text %}<small class="form-text text-muted">{{ profile_form.fasPronoun.help_text }}</small>{% endif %}
			<datalist id="pronoun-options">
				<option value="she / her / hers"></option>
				<option value="he / him / his"></option>
				<option value="they / them / theirs"></option>
			</datalist>
		</div>

		{% include "core/_form_field.html" with field=profile_form.country_code %}

		{% include "core/_form_field.html" with field=profile_form.fasLocale %}

		<div class="form-group">
			{{ profile_form.fasTimezone.label_tag }}
			{{ profile_form.fasTimezone }}
			<datalist id="timezone-options">
				{% for value, label in profile_form.fasTimezone.field.choices %}
					{% if value %}<option value="{{ value }}"></option>{% endif %}
				{% endfor %}
			</datalist>
			{% if profile_form.fasTimezone.errors %}<div class="text-danger">{{ profile_form.fasTimezone.errors }}</div>{% endif %}
			{% if profile_form.fasTimezone.help_text %}<small class="form-text text-muted">{{ profile_form.fasTimezone.help_text }}</small>{% endif %}
		</div>

		<div class="form-group">
			<label>{{ profile_form.fasWebsiteUrl.label }}</label>

			<div id="website-urls-widget" class="d-none">
				<div class="table-responsive">
					<table class="table table-sm table-bordered align-middle mb-2" id="website-urls-table">
						<tbody></tbody>
					</table>
				</div>
				<button type="button" class="btn btn-sm btn-outline-secondary" id="website-urls-add" title="Add another website URL">Add website URL</button>
			</div>

			<div id="website-urls-fallback">
				{{ profile_form.fasWebsiteUrl }}
				{% if profile_form.fasWebsiteUrl.errors %}<div class="text-danger">{{ profile_form.fasWebsiteUrl.errors }}</div>{% endif %}
			</div>
			{% if profile_form.fasWebsiteUrl.help_text %}<small class="form-text text-muted">{{ profile_form.fasWebsiteUrl.help_text }}</small>{% endif %}
		</div>

		<div class="form-group">
			<label>{{ profile_form.fasRssUrl.label }}</label>

			<div id="rss-urls-widget" class="d-none">
				<div class="table-responsive">
					<table class="table table-sm table-bordered align-middle mb-2" id="rss-urls-table">
						<tbody></tbody>
					</table>
				</div>
				<button type="button" class="btn btn-sm btn-outline-secondary" id="rss-urls-add" title="Add another RSS URL">Add RSS URL</button>
			</div>

			<div id="rss-urls-fallback">
				{{ profile_form.fasRssUrl }}
				{% if profile_form.fasRssUrl.errors %}<div class="text-danger">{{ profile_form.fasRssUrl.errors }}</div>{% endif %}
			</div>
			{% if profile_form.fasRssUrl.help_text %}<small class="form-text text-muted">{{ profile_form.fasRssUrl.help_text }}</small>{% endif %}
		</div>

		<div class="form-group">
			<label>Chat Nicknames</label>

			<small class="form-text text-muted">
				The format is either <strong>username</strong> or <strong>username:server.name</strong> (IRC/Matrix). For Mattermost custom servers use <strong>@username:server.name:team</strong>:
				<ul class="mb-0">
					<li>For Mattermost: <strong>{{ chat_networks.mattermost.default_server }}</strong> (team <strong>{{ chat_networks.mattermost.default_team }}</strong>)</li>
					<li>For IRC: <strong>{{ chat_networks.irc.default_server }}</strong></li>
					<li>For Matrix: <strong>{{ chat_networks.matrix.default_server }}</strong></li>
				</ul>
			</small>

			<div
				id="chat-nicks-widget"
				class="d-none js-chat-nicks-editor"
				data-textarea-id="{{ profile_form.fasIRCNick.id_for_label }}"
				data-fallback-id="chat-nicks-fallback"
				data-mattermost-default-server="{{ chat_networks.mattermost.default_server }}"
				data-mattermost-default-team="{{ chat_networks.mattermost.default_team }}"
				data-irc-default-server="{{ chat_networks.irc.default_server }}"
				data-matrix-default-server="{{ chat_networks.matrix.default_server }}"
			>
				<div class="table-responsive">
					<table class="table table-sm table-bordered align-middle mb-2" id="chat-nicks-table">
						<tbody></tbody>
					</table>
				</div>
				<button type="button" class="btn btn-sm btn-outline-secondary js-chat-nicks-add" id="chat-nicks-add" title="Add another chat nickname">Add nickname</button>
			</div>

			<div id="chat-nicks-fallback">
				{{ profile_form.fasIRCNick.label_tag }}
				{{ profile_form.fasIRCNick }}
				{% if profile_form.fasIRCNick.errors %}<div class="text-danger">{{ profile_form.fasIRCNick.errors }}</div>{% endif %}
				{% if profile_form.fasIRCNick.help_text %}<small class="form-text text-muted">{{ profile_form.fasIRCNick.help_text }}</small>{% endif %}
			</div>
		</div>

		<div class="form-group">
			{{ profile_form.fasGitHubUsername.label_tag }}
			<div class="input-group">
				<div class="input-group-prepend">
					<span class="input-group-text">@</span>
				</div>
				{{ profile_form.fasGitHubUsername }}
			</div>
			{% if profile_form.fasGitHubUsername.errors %}<div class="text-danger">{{ profile_form.fasGitHubUsername.errors }}</div>{% endif %}
		</div>

		<div class="form-group">
			{{ profile_form.fasGitLabUsername.label_tag }}
			<div class="input-group">
				<div class="input-group-prepend">
					<span class="input-group-text">@</span>
				</div>
				{{ profile_form.fasGitLabUsername }}
			</div>
			{% if profile_form.fasGitLabUsername.errors %}<div class="text-danger">{{ profile_form.fasGitLabUsername.errors }}</div>{% endif %}
		</div>

		<div class="form-group form-check">
			{{ profile_form.fasIsPrivate }}
			<label class="form-check-label" for="{{ profile_form.fasIsPrivate.id_for_label }}">{{ profile_form.fasIsPrivate.label }} <small class="text-muted">Hide personal details (including your name and email) from other signed-in users. Your profile stays visible, as do your groups and memberships.</small></label>
			{% if profile_form.fasIsPrivate.errors %}<div class="text-danger">{{ profile_form.fasIsPrivate.errors }}</div>{% endif %}
		</div>
	</div>

	<div class="d-flex justify-content-end">
		<button type="submit" class="btn btn-primary" title="Save profile changes">Save</button>
	</div>
</form>

{% include 'core/_modal_avatar_settings.html' %}

<script src="{% static 'core/js/chat_nicknames_editor.js' %}"></script>

<script>
	(function () {
		function onReady(fn) {
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', fn);
			} else {
				fn();
			}
		}

		onReady(function () {
			setupRowEditor({
				textareaId: 'id_fasWebsiteUrl',
				widgetId: 'website-urls-widget',
				fallbackId: 'website-urls-fallback',
				tableBodySelector: '#website-urls-table tbody',
				addBtnId: 'website-urls-add',
				rowClass: 'website-urls-row',
				kind: 'url',
				inputClass: 'website-urls-value',
				placeholder: 'https://example.com',
				splitComma: true
			});

			setupRowEditor({
				textareaId: 'id_fasRssUrl',
				widgetId: 'rss-urls-widget',
				fallbackId: 'rss-urls-fallback',
				tableBodySelector: '#rss-urls-table tbody',
				addBtnId: 'rss-urls-add',
				rowClass: 'rss-urls-row',
				kind: 'url',
				inputClass: 'rss-urls-value',
				placeholder: 'https://example.com/rss.xml',
				splitComma: true
			});
		});
	})();
</script>
