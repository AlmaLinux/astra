{% load static %}

<form method="post" novalidate class="m-0" data-settings-save-all="1">
	{% csrf_token %}
	<input type="hidden" name="tab" value="profile" />

	{% if profile_form.non_field_errors %}
		<div class="alert alert-danger">{{ profile_form.non_field_errors }}</div>
	{% endif %}

	<div class="settings-form">
		<div class="settings-profile-hero mb-4">
			<div class="d-flex align-items-center">
				<div class="settings-profile-avatar">
					<img src="{{ avatar_url }}" class="img-fluid img-circle" style="width:96px;height:96px;object-fit:cover;" alt="Avatar" />
				</div>
				<div class="ml-3">
					<button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#avatar-modal" title="Update your avatar">Change avatar</button>
					<div class="mt-1">
						<small class="text-muted">Upload a local avatar, or keep using your current avatar provider.</small>
					</div>
				</div>
			</div>
		</div>

		<div class="form-row">
			{% include 'core/_form_field.html' with field=profile_form.givenname wrapper_class='col-md-6' %}
			{% include 'core/_form_field.html' with field=profile_form.sn wrapper_class='col-md-6' %}
		</div>

		{% include 'core/_form_field.html' with field=profile_form.fasPronoun %}

		<datalist id="pronoun-options">
			<option value="she / her / hers"></option>
			<option value="he / him / his"></option>
			<option value="they / them / theirs"></option>
		</datalist>

		{% if highlight == 'country_code' %}
			{% include 'core/_form_field.html' with field=profile_form.country_code wrapper_class='settings-field-highlight' wrapper_attrs='id="country-code-field-wrapper"' %}
		{% else %}
			{% include 'core/_form_field.html' with field=profile_form.country_code wrapper_attrs='id="country-code-field-wrapper"' %}
		{% endif %}

		{% include 'core/_form_field_datalist.html' with field=profile_form.fasLocale datalist_id='locale-options' datalist_options=profile_form.fasLocale.field.choices %}

		{% include 'core/_form_field_datalist.html' with field=profile_form.fasTimezone datalist_id='timezone-options' datalist_options=profile_form.fasTimezone.field.choices %}

		{% include 'core/_form_field_widget_fallback.html' with field=profile_form.fasWebsiteUrl widget_id='website-urls-widget' fallback_id='website-urls-fallback' table_id='website-urls-table' add_button_id='website-urls-add' add_button_title='Add another website URL' add_button_text='Add website URL' %}

		{% include 'core/_form_field_widget_fallback.html' with field=profile_form.fasRssUrl widget_id='rss-urls-widget' fallback_id='rss-urls-fallback' table_id='rss-urls-table' add_button_id='rss-urls-add' add_button_title='Add another RSS URL' add_button_text='Add RSS URL' %}

		<small class="form-text text-muted">
			The format is either <strong>username</strong> or <strong>username:server.name</strong> (IRC/Matrix). For Mattermost custom servers use <strong>@username:server.name:team</strong>:
			<ul class="mb-0">
				<li>For Mattermost: <strong>{{ chat_networks.mattermost.default_server }}</strong> (team <strong>{{ chat_networks.mattermost.default_team }}</strong>)</li>
				<li>For IRC: <strong>{{ chat_networks.irc.default_server }}</strong></li>
				<li>For Matrix: <strong>{{ chat_networks.matrix.default_server }}</strong></li>
			</ul>
		</small>
		{% include 'core/_form_field_widget_fallback.html' with field=profile_form.fasIRCNick widget_id='chat-nicks-widget' fallback_id='chat-nicks-fallback' widget_class='d-none js-chat-nicks-editor' data_textarea_id=profile_form.fasIRCNick.id_for_label data_fallback_id='chat-nicks-fallback' data_mattermost_default_server=chat_networks.mattermost.default_server data_mattermost_default_team=chat_networks.mattermost.default_team data_irc_default_server=chat_networks.irc.default_server data_matrix_default_server=chat_networks.matrix.default_server table_id='chat-nicks-table' add_button_id='chat-nicks-add' add_button_class='js-chat-nicks-add' add_button_title='Add another chat nickname' add_button_text='Add nickname' %}

		{% include 'core/_form_field_input_group.html' with field=profile_form.fasGitHubUsername prefix='@' %}

		{% include 'core/_form_field_input_group.html' with field=profile_form.fasGitLabUsername prefix='@' %}

		{% include 'core/_form_field_checkbox.html' with field=profile_form.fasIsPrivate help_text_override='Hide personal details (including your name and email) from other signed-in users. Your profile stays visible, as do your groups and memberships.' %}
	</div>

	<div class="d-flex justify-content-end">
		<button type="submit" class="btn btn-primary" title="Save profile changes">Save</button>
	</div>
</form>

{% include 'core/_modal_avatar_settings.html' %}

<script src="{% static 'core/js/chat_nicknames_editor.js' %}"></script>

<script>
	(function () {
		function onReady(fn) {
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', fn);
			} else {
				fn();
			}
		}

		onReady(function () {
			setupRowEditor({
				textareaId: 'id_fasWebsiteUrl',
				widgetId: 'website-urls-widget',
				fallbackId: 'website-urls-fallback',
				tableBodySelector: '#website-urls-table tbody',
				addBtnId: 'website-urls-add',
				rowClass: 'website-urls-row',
				kind: 'url',
				inputClass: 'website-urls-value',
				placeholder: 'https://example.com',
				splitComma: true
			});

			setupRowEditor({
				textareaId: 'id_fasRssUrl',
				widgetId: 'rss-urls-widget',
				fallbackId: 'rss-urls-fallback',
				tableBodySelector: '#rss-urls-table tbody',
				addBtnId: 'rss-urls-add',
				rowClass: 'rss-urls-row',
				kind: 'url',
				inputClass: 'rss-urls-value',
				placeholder: 'https://example.com/rss.xml',
				splitComma: true
			});

			if ('{{ highlight|default:""|escapejs }}' === 'country_code') {
				var countryInput = document.getElementById('id_country_code');
				if (countryInput && typeof countryInput.focus === 'function') {
					countryInput.focus();
				}
			}
		});
	})();
</script>
