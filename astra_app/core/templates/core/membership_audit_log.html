{% extends 'core/base.html' %}

{% load core_membership_responses %}

{% block title %}Membership Audit Log{% endblock %}

{% block header %}
  <h1 class="m-0">
    Membership Audit Log
    {% if filter_username %}: {{ filter_username }}{% elif filter_organization %}: org:{{ filter_organization }}{% endif %}
  </h1>
{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-header">
      <div class="card-tools">
        {% include 'core/_search_form.html' with search_value=q search_placeholder="Search" search_aria_label="Search membership audit log" search_submit_title="Search audit log" search_width="260px" search_hidden_fields_template="core/_audit_log_search_hidden_fields.html" %}
      </div>
    </div>

    <div class="card-body p-0">
      <table class="table table-striped mb-0">
        <thead>
          <tr>
            <th class="text-nowrap" style="width: 1%; white-space: nowrap;">When</th>
            <th class="text-nowrap" style="width: 1%; white-space: nowrap;">Who</th>
            <th class="text-nowrap" style="width: 1%; white-space: nowrap;">Target</th>
            <th class="text-nowrap" style="width: 1%; white-space: nowrap;">Membership</th>
            <th>Action</th>
            <th class="text-nowrap" style="width: 1%; white-space: nowrap;">Expires</th>
          </tr>
        </thead>
        <tbody>
          {% for l in logs %}
            <tr>
              <td class="text-muted text-nowrap" style="width: 1%; white-space: nowrap;">
                {% if l.membership_request %}<a href="{% url 'membership-request-detail' l.membership_request.pk %}">Request #{{ l.membership_request.pk }}</a><br/>{% endif %}
                {{ l.created_at|date:"r" }}
              </td>
              <td>{{ l.actor_username }}</td>
              <td>
                {% if l.target_username == '' %}
                  {% if l.target_organization %}
                    <a href="{% url 'organization-detail' l.target_organization.pk %}">{{ l.target_organization.name }}</a>
                  {% else %}
                    <span>{{ l.target_organization_name }}</span>
                    <span class="text-muted">(deleted)</span>
                  {% endif %}
                {% else %}
                  <a href="{% url 'user-profile' l.target_username %}">{{ l.target_username }}</a>
                {% endif %}
              </td>
              <td>{{ l.membership_type.name }}</td>
              <td>
                {{ l.get_action_display }}
                {% if l.membership_request %}
                  <details class="mt-1">
                    <summary class="small text-muted">Request responses</summary>
                    <div class="mt-2">
                      {% for item in l.membership_request.responses %}
                        {% for k,v in item.items %}
                            <div class="small text-muted font-weight-bold">{{ k }}</div>
                            <div class="small" style="white-space: pre-wrap;">{{ v|membership_response_value:k }}</div>
                        {% endfor %}
                      {% endfor %}
                    </div>
                  </details>
                {% endif %}
              </td>
              <td class="text-muted text-nowrap" style="width: 1%; white-space: nowrap;">{% if l.expires_at %}{{ l.expires_at|date:"M j, Y" }}{% endif %}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="p-3 text-muted">No audit log entries.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card-footer clearfix">
      {% include "core/_pagination.html" %}
    </div>
  </div>
{% endblock %}
