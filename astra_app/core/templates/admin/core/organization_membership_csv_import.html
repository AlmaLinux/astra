{% extends "admin/import_export/import.html" %}

{% load admin_urls %}
{% load i18n %}
{% load jazzmin %}
{% load static %}
{% get_jazzmin_ui_tweaks as jazzmin_ui %}

{% block extrahead %}
  {{ block.super }}
  <script src="{% static 'core/js/csv_import_headers.js' %}"></script>
  <script>
    (function () {
      if (!window.csvImportHeaders) {
        return;
      }
      const norm = window.csvImportHeaders.norm;
      const chooseDelimiter = window.csvImportHeaders.chooseDelimiter;
      const parseCsvRow = window.csvImportHeaders.parseCsvRow;
      const pickHeader = window.csvImportHeaders.pickHeader;

      function init() {
        const fileInput = document.getElementById("id_import_file");
        const formatSelect = document.getElementById("id_format");
        const headerPreview = document.getElementById("csv-header-preview");
        const headerPreviewItems = document.getElementById("csv-header-preview-items");
        const selects = Array.from(document.querySelectorAll("select")).filter((el) => el.id && el.id.endsWith("_column"));

        if (!fileInput) {
          return;
        }

        function ensureCsvFormatSelected() {
          if (!formatSelect) {
            return;
          }
          const options = Array.from(formatSelect.options || []);
          const csvOption = options.find((opt) => {
            const valueNorm = norm(opt.value);
            const labelNorm = norm(opt.text || opt.label || "");
            return valueNorm.includes("csv") || labelNorm.includes("csv");
          });
          if (csvOption) {
            formatSelect.value = csvOption.value;
          }
        }

        function applyHeaders(headers) {
          for (const select of selects) {
            const current = select.value;
            select.options.length = 0;

            const autoOption = document.createElement("option");
            autoOption.value = "";
            autoOption.textContent = "Auto-detect";
            select.appendChild(autoOption);

            for (const header of headers) {
              const option = document.createElement("option");
              option.value = header;
              option.textContent = header;
              select.appendChild(option);
            }

            if (current) {
              select.value = current;
              continue;
            }

            const preferredAttr = (select.dataset.preferredNorms || "")
              .split("|")
              .map(norm)
              .filter(Boolean);
            const logicalName = (select.id || "").replace(/^id_/, "").replace(/_column$/, "");
            const preferred = preferredAttr.length
              ? preferredAttr
              : [logicalName, logicalName.replaceAll("_", "")];
            const picked = pickHeader(headers, preferred);
            if (picked) {
              select.value = picked;
            }
          }

          if (headerPreview && headerPreviewItems) {
            headerPreviewItems.textContent = headers.join(", ");
            headerPreview.style.display = headers.length ? "block" : "none";
          }
        }

        fileInput.addEventListener("change", function () {
          const file = fileInput.files && fileInput.files[0];
          if (!file) {
            return;
          }

          ensureCsvFormatSelected();
          const reader = new FileReader();
          reader.onload = function () {
            const text = (reader.result || "").toString();
            const lines = text.split(/\r\n|\n|\r/).filter(Boolean);
            if (!lines.length) {
              return;
            }
            const firstLine = lines[0].replace(/^\uFEFF/, "");
            const delimiter = chooseDelimiter(firstLine);
            const headers = parseCsvRow(firstLine, delimiter);
            applyHeaders(headers);
          };
          reader.readAsText(file);
        });
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>

  {% if confirm_form %}
    <script>
      (function () {
        function parseSelected(raw) {
          const out = new Set();
          if (!raw) {
            return out;
          }
          for (const part of raw.split(",")) {
            const trimmed = (part || "").toString().trim();
            if (!trimmed) {
              continue;
            }
            const n = Number.parseInt(trimmed, 10);
            if (Number.isFinite(n) && n > 0) {
              out.add(n);
            }
          }
          return out;
        }

        function setToCsv(set) {
          return Array.from(set).sort((a, b) => a - b).join(",");
        }

        function bootSelection() {
          const selectedInput = document.querySelector("input[name='selected_row_numbers']");
          if (!selectedInput) {
            return;
          }

          const allMatchInput = document.getElementById("id_all_match_row_numbers");
          const allMatchCsv = allMatchInput ? (allMatchInput.value || "") : "";
          const selectAll = document.getElementById("id_select_all_matches");
          const checkboxes = Array.from(document.querySelectorAll("input.js-match-select[data-row-number]"));

          function applySelectedToCheckboxes(selected) {
            for (const cb of checkboxes) {
              const n = Number.parseInt(cb.dataset.rowNumber || "", 10);
              cb.checked = Number.isFinite(n) ? selected.has(n) : false;
            }
          }

          function updateSelectAllState(selected) {
            if (!selectAll) {
              return;
            }
            const allSet = parseSelected(allMatchCsv);
            selectAll.checked = allSet.size > 0 && allSet.size === selected.size;
          }

          function saveSelected(selected) {
            selectedInput.value = setToCsv(selected);
            updateSelectAllState(selected);
          }

          let selected = parseSelected(selectedInput.value);
          applySelectedToCheckboxes(selected);
          updateSelectAllState(selected);

          for (const cb of checkboxes) {
            cb.addEventListener("change", function () {
              const n = Number.parseInt(cb.dataset.rowNumber || "", 10);
              if (!Number.isFinite(n) || n <= 0) {
                return;
              }
              if (cb.checked) {
                selected.add(n);
              } else {
                selected.delete(n);
              }
              saveSelected(selected);
            });
          }

          if (selectAll) {
            selectAll.addEventListener("change", function () {
              selected = selectAll.checked ? parseSelected(allMatchCsv) : new Set();
              applySelectedToCheckboxes(selected);
              saveSelected(selected);
            });
          }

          for (const link of Array.from(document.querySelectorAll("a.js-preview-page-link"))) {
            link.addEventListener("click", function () {
              if (!selectedInput.value) {
                return;
              }
              try {
                const url = new URL(link.href, window.location.href);
                url.searchParams.set("selected_row_numbers", selectedInput.value);
                link.href = url.toString();
              } catch (err) {
                // If URL manipulation fails, keep the original link.
              }
            });
          }
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", bootSelection);
        } else {
          bootSelection();
        }
      })();
    </script>
  {% endif %}
{% endblock %}

{% block content %}
  <div class="col-12">
    {% if unmatched_download_url %}
      <div class="messagelist">
        <ul class="messagelist">
          <li class="warning">Unmatched organizations export: <a href="{{ unmatched_download_url }}">download CSV</a></li>
        </ul>
      </div>
    {% endif %}

    {% if confirm_form %}
      <form action="{% url opts|admin_urlname:"process_import" %}" method="POST">
        {% csrf_token %}
        <div class="row">
          <div class="col-12 col-lg-9">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Preview Import</div>
              </div>
              <div class="card-body">
                {{ confirm_form.as_p }}
                <p>Review organization memberships before confirming import.</p>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-edit"></i>
                  Actions
                </h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <input type="submit" class="btn {{ jazzmin_ui.button_classes.success }} form-control" name="confirm" value="Confirm import" title="Confirm and start import">
                </div>
              </div>
            </div>
          </div>
        </div>

        <input type="hidden" id="id_all_match_row_numbers" value="{{ all_match_row_numbers_csv|default:"" }}">

        {% if preview_summary %}
          <div class="row mt-3">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Preview summary</div>
                </div>
                <div class="card-body">
                  Total rows: <strong>{{ preview_summary.total }}</strong><br>
                  Organizations to import: <strong>{{ preview_summary.to_import }}</strong><br>
                  Rows skipped: <strong>{{ preview_summary.skipped }}</strong>
                </div>
              </div>
            </div>
          </div>
        {% endif %}

        <div class="row mt-3">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Organizations to Import</div>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <label for="id_select_all_matches" style="display: inline-block; margin-right: 0.5rem;">Select all</label>
                  <input id="id_select_all_matches" type="checkbox">
                </div>

                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th></th>
                      <th>Row</th>
                      <th>Organization ID</th>
                      <th>Organization Name</th>
                      <th>Matched Organization</th>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Notes</th>
                      <th>Decision</th>
                      <th>Reason</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in matches_page_obj %}
                      <tr>
                        <td>
                          <input class="js-match-select" type="checkbox" data-row-number="{{ row.astra_row_number }}">
                        </td>
                        <td>{{ row.astra_row_number }}</td>
                        <td>{{ row.instance.csv_organization_id }}</td>
                        <td>{{ row.instance.csv_organization_name }}</td>
                        <td>{{ row.instance.matched_organization }}</td>
                        <td>{{ row.instance.csv_membership_start_date }}</td>
                        <td>{{ row.instance.csv_membership_end_date }}</td>
                        <td>{{ row.instance.csv_committee_notes }}</td>
                        <td>{{ row.instance.decision }}</td>
                        <td>{{ row.instance.decision_reason }}</td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="10">No rows ready for import.</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>

                {% if matches_page_obj and matches_page_obj.paginator.num_pages|default:0 > 1 %}
                  <div class="paginator">
                    {% if matches_page_obj.has_previous %}
                      <a class="js-preview-page-link" href="?matches_page={{ matches_page_obj.previous_page_number }}&skipped_page={{ skipped_page_obj.number|default:1 }}">Previous</a>
                    {% endif %}
                    <span>Page {{ matches_page_obj.number }} of {{ matches_page_obj.paginator.num_pages }}</span>
                    {% if matches_page_obj.has_next %}
                      <a class="js-preview-page-link" href="?matches_page={{ matches_page_obj.next_page_number }}&skipped_page={{ skipped_page_obj.number|default:1 }}">Next</a>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Skipped</div>
              </div>
              <div class="card-body">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>Row</th>
                      <th>Organization ID</th>
                      <th>Organization Name</th>
                      <th>Decision</th>
                      <th>Reason</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in skipped_page_obj %}
                      <tr>
                        <td>{{ row.astra_row_number }}</td>
                        <td>{{ row.instance.csv_organization_id }}</td>
                        <td>{{ row.instance.csv_organization_name }}</td>
                        <td>{{ row.instance.decision }}</td>
                        <td>{{ row.instance.decision_reason }}</td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="5">No skipped rows.</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>

                {% if skipped_page_obj and skipped_page_obj.paginator.num_pages|default:0 > 1 %}
                  <div class="paginator">
                    {% if skipped_page_obj.has_previous %}
                      <a class="js-preview-page-link" href="?matches_page={{ matches_page_obj.number|default:1 }}&skipped_page={{ skipped_page_obj.previous_page_number }}">Previous</a>
                    {% endif %}
                    <span>Page {{ skipped_page_obj.number }} of {{ skipped_page_obj.paginator.num_pages }}</span>
                    {% if skipped_page_obj.has_next %}
                      <a class="js-preview-page-link" href="?matches_page={{ matches_page_obj.number|default:1 }}&skipped_page={{ skipped_page_obj.next_page_number }}">Next</a>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </form>
    {% else %}
      <form action="" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row">
          <div class="col-12 col-lg-9">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Upload Organization Membership CSV</div>
              </div>
              <div class="card-body">
                {% for field in form %}
                  {% if field.is_hidden %}
                    {{ field }}
                  {% elif field.name == "import_file" %}
                    <div class="form-group field-name">
                      <div class="row">
                        {{ field.errors }}
                        <div class="col-sm-3 text-left">{{ field.label_tag }}</div>
                        <div class="col-sm-9 text-left">
                          {{ field }}
                          <div id="csv-header-preview" class="help mt-1" style="display: none;">
                            <strong>Detected CSV headers:</strong>
                            <span id="csv-header-preview-items"></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <div class="form-group field-name">
                      <div class="row">
                        {{ field.errors }}
                        <div class="col-sm-3 text-left">{{ field.label_tag }}</div>
                        <div class="col-sm-9 text-left">{{ field }}</div>
                        {% if field.field.help_text %}
                          <div class="help-block col-sm-12">{{ field.field.help_text }}</div>
                        {% endif %}
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}

                <div class="card mt-3">
                  <div class="card-header"><strong>CSV format</strong></div>
                  <div class="card-body">
                    <p class="mb-2">
                      Required:
                      {% if required_csv_columns %}
                        {% for column_name in required_csv_columns %}
                          <code>{{ column_name }}</code>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                      {% else %}
                        <em>None</em>
                      {% endif %}
                    </p>
                    <p class="mb-2">
                      Optional:
                      {% if optional_csv_columns %}
                        {% for column_name in optional_csv_columns %}
                          <code>{{ column_name }}</code>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                      {% else %}
                        <em>None</em>
                      {% endif %}
                    </p>
                    <p class="mb-0">Membership type is selected above and applies to all imported rows.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-edit"></i>
                  Actions
                </h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <input type="submit" class="btn {{ jazzmin_ui.button_classes.success }} form-control" name="confirm" value="Upload and Preview" title="Upload CSV and preview results">
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    {% endif %}
  </div>
{% endblock %}
