{% extends "admin/import_export/import.html" %}

{% load admin_urls %}
{% load i18n %}
{% load jazzmin %}
{% load static %}
{% get_jazzmin_ui_tweaks as jazzmin_ui %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    /*
      import-export sets dark row backgrounds but doesn't always ensure
      foreground/link contrast matches Django admin themes. Force readable
      colors in the preview table.
    */
    table.import-preview {
      font-size: 14px;
      line-height: 1.35;
      width: 100%;
      table-layout: fixed;
      background-color: var(--body-bg, #fff);
      color: var(--body-color, #212529);
    }

    table.import-preview th,
    table.import-preview td {
      padding: 0.5rem;
      vertical-align: top;
      word-break: break-word;
      color: var(--body-color, #212529);
    }

    table.import-preview td ins {
      background-color: #e6ffe6 !important;
    }

    table.import-preview a {
      color: inherit;
      text-decoration: underline;
    }

    table.import-preview tr.new {
      background-color: rgba(25, 135, 84, 0.08);
    }

    table.import-preview tr.update {
      background-color: rgba(255, 193, 7, 0.08);
    }

    table.import-preview tr.delete {
      background-color: rgba(220, 53, 69, 0.08);
    }

    table.import-preview tr.skip {
      background-color: rgba(0, 0, 0, 0.03);
    }
  </style>
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script src="{% static 'core/js/csv_import_headers.js' %}"></script>
  <script>
    (function () {
      const csvImportHeaders = window.csvImportHeaders || {};
      const norm = csvImportHeaders.norm || function (value) {
        return (value || "").toString().trim().toLowerCase().replace(/[^a-z0-9]/g, "");
      };
      const chooseDelimiter = csvImportHeaders.chooseDelimiter || function (line) {
        const candidates = [",", "\t", ";", "|"];
        let best = ",";
        let bestCount = -1;
        for (const delimiter of candidates) {
          const count = line.split(delimiter).length - 1;
          if (count > bestCount) {
            bestCount = count;
            best = delimiter;
          }
        }
        return best;
      };
      const parseCsvRow = csvImportHeaders.parseCsvRow || function (line, delimiter) {
        const out = [];
        let current = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i += 1) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i += 1;
              continue;
            }
            inQuotes = !inQuotes;
            continue;
          }
          if (ch === delimiter && !inQuotes) {
            out.push(current.trim());
            current = "";
            continue;
          }
          current += ch;
        }
        if (current || line.endsWith(delimiter)) {
          out.push(current.trim());
        }
        return out.filter(Boolean);
      };
      const pickHeader = csvImportHeaders.pickHeader || function (headers, preferredNorms) {
        const normalized = headers.map((header) => ({ raw: header, norm: norm(header) }));
        for (const preferred of preferredNorms) {
          const match = normalized.find((item) => item.norm === norm(preferred));
          if (match) {
            return match.raw;
          }
        }
        return "";
      };

      function questionFieldVisibilityIsConsistent(questionRows, selectedType) {
        if (!questionRows.length) {
          return true;
        }
        return questionRows.every((row) => {
          const allowedRaw = row.dataset.membershipTypes || "";
          if (!allowedRaw.trim()) {
            return true;
          }
          const allowed = allowedRaw.split(",").map((v) => v.trim()).filter(Boolean);
          const shouldShow = !selectedType || allowed.includes(selectedType);
          return shouldShow === (row.style.display !== "none");
        });
      }

      function toggleQuestionFields(questionRows, selectedType) {
        if (!questionRows.length) {
          return;
        }
        for (const row of questionRows) {
          const allowedRaw = row.dataset.membershipTypes || "";
          if (!allowedRaw.trim()) {
            row.style.display = "";
            continue;
          }
          const allowed = allowedRaw.split(",").map((v) => v.trim()).filter(Boolean);
          const shouldShow = !selectedType || allowed.includes(selectedType);
          row.style.display = shouldShow ? "" : "none";
        }
      }

      function initWhenReady() {
        const membershipTypeSelect = document.getElementById("id_membership_type");
        const fileInput = document.getElementById("id_import_file");
        const formatSelect = document.getElementById("id_format");
        const headerList = document.getElementById("csv-header-preview");
        const headerListItems = document.getElementById("csv-header-preview-items");

        const fieldIds = {
          email: "id_email_column",
          name: "id_name_column",
          active: "id_active_member_column",
          start: "id_membership_start_date_column",
          notes: "id_committee_notes_column",
          type: "id_membership_type_column",
        };

        const fields = {
          email: document.getElementById(fieldIds.email),
          name: document.getElementById(fieldIds.name),
          active: document.getElementById(fieldIds.active),
          start: document.getElementById(fieldIds.start),
          notes: document.getElementById(fieldIds.notes),
          type: document.getElementById(fieldIds.type),
        };

        const selects = Array.from(document.querySelectorAll("select[data-preferred-norms]"));
        const columnSelectorRows = Array.from(document.querySelectorAll(".js-column-selector-row"));
        const questionRows = Array.from(document.querySelectorAll(".js-column-selector-row[data-membership-types]"));

        if (!fileInput && !selects.length && !membershipTypeSelect && !formatSelect) {
          return false;
        }

        function ensureCsvFormatSelected() {
          if (!formatSelect) {
            return;
          }
          const options = Array.from(formatSelect.options || []);
          const csvOption = options.find((opt) => {
            const valueNorm = norm(opt.value);
            const labelNorm = norm(opt.text || opt.label || "");
            return valueNorm.includes("csv") || labelNorm.includes("csv");
          });
          if (csvOption) {
            formatSelect.value = csvOption.value;
          }
        }

        function populateSelectOptions(headers) {
          const optionTargets = Array.from(new Set([...Object.values(fields).filter(Boolean), ...selects]));
          for (const select of optionTargets) {
            const current = select.value;
            select.options.length = 0;
            const autoOption = document.createElement("option");
            autoOption.value = "";
            autoOption.textContent = "Auto-detect";
            select.appendChild(autoOption);
            for (const header of headers) {
              const opt = document.createElement("option");
              opt.value = header;
              opt.textContent = header;
              select.appendChild(opt);
            }
            if (current) {
              select.value = current;
            }
            if (window.jQuery) {
              try {
                window.jQuery(select).trigger("change.select2");
              } catch (e) {
                // Ignore if select2 is not bound.
              }
            }
          }
        }

        function applyHeaders(headers) {
          populateSelectOptions(headers);
          const picks = {
            email: ["email", "emailaddress", "mail"],
            name: ["name", "fullname", "displayname"],
            active: ["activemember", "active", "status", "memberstatus"],
            start: ["membershipstartdate", "startdate", "memberstartdate"],
            notes: ["committeenotes", "notes", "committee"],
            type: ["membershiptype", "type", "level"],
          };

          for (const key of Object.keys(fields)) {
            const field = fields[key];
            if (!field || field.tagName !== "SELECT" || field.value) {
              continue;
            }
            const picked = pickHeader(headers, picks[key] || []);
            if (picked) {
              field.value = picked;
            }
          }

          for (const sel of selects) {
            if (sel.value) {
              continue;
            }
            const preferred = sel.dataset.preferredNorms || "";
            const preferredNorms = preferred.split("|").map(norm).filter(Boolean);
            if (preferredNorms.length) {
              const picked = pickHeader(headers, preferredNorms);
              if (picked) {
                sel.value = picked;
              }
            }
          }

          if (headerList && headerListItems) {
            headerListItems.textContent = headers.join(", ");
            headerList.style.display = headers.length ? "block" : "none";
          }
        }

        if (fileInput) {
          fileInput.addEventListener("change", function () {
            const file = fileInput.files && fileInput.files[0];
            if (!file) {
              updateColumnSelectorVisibility();
              return;
            }

            ensureCsvFormatSelected();
            updateColumnSelectorVisibility();
            const reader = new FileReader();
            reader.onload = function () {
              const text = (reader.result || "").toString();
              const lines = text.split(/\r\n|\n|\r/).filter(Boolean);
              if (!lines.length) {
                return;
              }
              const firstLine = lines[0].replace(/^\uFEFF/, "");
              const delimiter = chooseDelimiter(firstLine);
              const headers = parseCsvRow(firstLine, delimiter);
              if (headers.length) {
                applyHeaders(headers);
              }
            };
            reader.readAsText(file);
          });
        }

        function updateQuestionVisibility() {
          const selected = membershipTypeSelect ? membershipTypeSelect.value : "";
          toggleQuestionFields(questionRows, selected);
        }

        function updateColumnSelectorVisibility() {
          const hasFile = !!(fileInput && fileInput.files && fileInput.files.length);
          if (!hasFile) {
            for (const row of columnSelectorRows) {
              row.style.display = "none";
            }
            return;
          }

          for (const row of columnSelectorRows) {
            if (!row.dataset.membershipTypes) {
              row.style.display = "";
            }
          }
          updateQuestionVisibility();
        }

        if (membershipTypeSelect) {
          membershipTypeSelect.addEventListener("change", updateColumnSelectorVisibility);
          if (window.jQuery) {
            try {
              window.jQuery(membershipTypeSelect).on("change select2:select select2:clear", updateColumnSelectorVisibility);
            } catch (e) {
              // Ignore binding errors.
            }
          }
        }

        updateColumnSelectorVisibility();
        ensureCsvFormatSelected();

        let toggleAttempts = 0;
        const toggleTimer = setInterval(function () {
          toggleAttempts += 1;
          updateColumnSelectorVisibility();
          if (questionFieldVisibilityIsConsistent(questionRows, membershipTypeSelect ? membershipTypeSelect.value : "") || toggleAttempts >= 30) {
            clearInterval(toggleTimer);
          }
        }, 100);

        return true;
      }

      function boot() {
        let attempts = 0;
        const timer = setInterval(function () {
          attempts += 1;
          if (initWhenReady() || attempts >= 50) {
            clearInterval(timer);
          }
        }, 50);
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", boot);
      } else {
        boot();
      }
    })();
  </script>

  {% if confirm_form %}
    <script>
      (function () {
        function parseSelected(raw) {
          const out = new Set();
          if (!raw) {
            return out;
          }
          for (const part of raw.split(",")) {
            const trimmed = (part || "").toString().trim();
            if (!trimmed) {
              continue;
            }
            const n = Number.parseInt(trimmed, 10);
            if (Number.isFinite(n) && n > 0) {
              out.add(n);
            }
          }
          return out;
        }

        function setToCsv(set) {
          return Array.from(set).sort((a, b) => a - b).join(",");
        }

        function bootSelection() {
          const selectedInput = document.querySelector("input[name='selected_row_numbers']");
          if (!selectedInput) {
            return;
          }

          const allMatchInput = document.getElementById("id_all_match_row_numbers");
          const allMatchCsv = allMatchInput ? (allMatchInput.value || "") : "";
          const selectAll = document.getElementById("id_select_all_matches");
          const checkboxes = Array.from(document.querySelectorAll("input.js-match-select[data-row-number]"));

          function applySelectedToCheckboxes(selected) {
            for (const cb of checkboxes) {
              const n = Number.parseInt(cb.dataset.rowNumber || "", 10);
              cb.checked = Number.isFinite(n) ? selected.has(n) : false;
            }
          }

          function updateSelectAllState(selected) {
            if (!selectAll) {
              return;
            }
            const allSet = parseSelected(allMatchCsv);
            selectAll.checked = allSet.size > 0 && allSet.size === selected.size;
          }

          function saveSelected(selected) {
            selectedInput.value = setToCsv(selected);
            updateSelectAllState(selected);
          }

          let selected = parseSelected(selectedInput.value);
          applySelectedToCheckboxes(selected);
          updateSelectAllState(selected);

          for (const cb of checkboxes) {
            cb.addEventListener("change", function () {
              const n = Number.parseInt(cb.dataset.rowNumber || "", 10);
              if (!Number.isFinite(n) || n <= 0) {
                return;
              }
              if (cb.checked) {
                selected.add(n);
              } else {
                selected.delete(n);
              }
              saveSelected(selected);
            });
          }

          if (selectAll) {
            selectAll.addEventListener("change", function () {
              selected = selectAll.checked ? parseSelected(allMatchCsv) : new Set();
              applySelectedToCheckboxes(selected);
              saveSelected(selected);
            });
          }

          for (const link of Array.from(document.querySelectorAll("a.js-preview-page-link"))) {
            link.addEventListener("click", function () {
              if (!selectedInput.value) {
                return;
              }
              try {
                const url = new URL(link.href, window.location.href);
                url.searchParams.set("selected_row_numbers", selectedInput.value);
                link.href = url.toString();
              } catch (err) {
                // If URL manipulation fails, fall back to the original link.
              }
            });
          }
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", bootSelection);
        } else {
          bootSelection();
        }
      })();
    </script>
  {% endif %}
{% endblock %}

{% block import_form_additional_info %}
  {% include "admin/core/_membership_csv_import_additional_info.html" %}
{% endblock %}

{% block content %}
  <div class="col-12">
    {% if unmatched_download_url %}
      <div class="messagelist">
        <ul class="messagelist">
          <li class="warning">Unmatched users export: <a href="{{ unmatched_download_url }}">download CSV</a></li>
        </ul>
      </div>
    {% endif %}

    {% if confirm_form %}
      <form action="{% url opts|admin_urlname:"process_import" %}" method="POST">
        {% csrf_token %}
        <div class="row">
          <div class="col-12 col-lg-9">
            <div class="card">
              <div class="card-header">
                <div class="card-title">{% trans 'Confirm Import' %}</div>
              </div>
              <div class="card-body">
                {{ confirm_form.as_p }}
                <p>
                  {% trans "Below is a preview of data to be imported. If you are satisfied with the results, click 'Confirm import'" %}
                </p>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-edit"></i>
                  {% trans 'Actions' %}
                </h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <input type="submit" class="btn {{ jazzmin_ui.button_classes.success }} form-control" name="confirm" value="{% trans 'Confirm import' %}" title="Confirm and start import">
                </div>
              </div>
            </div>
          </div>
        </div>

        <input type="hidden" id="id_all_match_row_numbers" value="{{ all_match_row_numbers_csv|default:"" }}">

        {% if csv_stats %}
          <div class="row mt-3">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">CSV match stats</div>
                </div>
                <div class="card-body">
                  Total rows: <strong>{{ csv_stats.total_records }}</strong><br>
                  Matched: <strong>{{ csv_stats.matched_total }}</strong> ({{ csv_stats.matched_total_percent }}%)<br>
                  Matched by email: <strong>{{ csv_stats.matched_by_email }}</strong><br>
                  Matched by name: <strong>{{ csv_stats.matched_by_name }}</strong>
                </div>
              </div>
            </div>
          </div>
        {% endif %}

        {% if result %}
          {% if result.has_errors or result.has_validation_errors %}
            <div class="row mt-3">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <div class="card-title">Import errors</div>
                  </div>
                  <div class="card-body">
                    {% if result.has_errors %}
                      <strong>Errors</strong>
                      <ul>
                        {% for error in result.base_errors %}
                          <li>{{ error.error }}</li>
                        {% endfor %}
                        {% for line, errors in result.row_errors %}
                          {% for error in errors %}
                            <li>Line {{ line }}: {{ error.error }}</li>
                          {% endfor %}
                        {% endfor %}
                      </ul>
                    {% endif %}

                    {% if result.has_validation_errors %}
                      <strong>Validation errors</strong>
                      <ul>
                        {% for error in result.invalid_rows %}
                          <li>Line {{ error.number }}: {{ error.error }}</li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <div class="row mt-3">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <div class="card-title">Matches</div>
                  </div>
                  <div class="card-body">
                    <div class="form-group">
                      <label for="id_select_all_matches" style="display: inline-block; margin-right: 0.5rem;">Select all</label>
                      <input id="id_select_all_matches" type="checkbox">
                    </div>

                    <table class="import-preview">
                      <thead>
                        <tr>
                          <th></th>
                          <th>Row</th>
                          <th></th>
                          {% for field in result.diff_headers %}
                            <th>{{ field }}</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        {% for row in matches_page_obj %}
                          <tr class="{{ row.import_type }}">
                            <td>
                              <input class="js-match-select" type="checkbox" data-row-number="{{ row.astra_row_number }}">
                            </td>
                            <td>{{ row.astra_row_number }}</td>
                            <td class="import-type">
                              {% if row.import_type == 'new' %}
                                New
                              {% elif row.import_type == 'skip' %}
                                Skipped
                              {% elif row.import_type == 'delete' %}
                                Delete
                              {% elif row.import_type == 'update' %}
                                Update
                              {% endif %}
                            </td>
                            {% for field in row.diff %}
                              <td>{{ field }}</td>
                            {% endfor %}
                          </tr>
                        {% empty %}
                          <tr>
                            <td colspan="{{ result.diff_headers|length|add:3 }}">No matches.</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>

                    {% if matches_page_obj and matches_page_obj.paginator.num_pages|default:0 > 1 %}
                      <div class="paginator">
                        {% if matches_page_obj.has_previous %}
                          <a class="js-preview-page-link" href="?matches_page={{ matches_page_obj.previous_page_number }}&skipped_page={{ skipped_page_obj.number|default:1 }}">Previous</a>
                        {% endif %}
                        <span>Page {{ matches_page_obj.number }} of {{ matches_page_obj.paginator.num_pages }}</span>
                        {% if matches_page_obj.has_next %}
                          <a class="js-preview-page-link" href="?matches_page={{ matches_page_obj.next_page_number }}&skipped_page={{ skipped_page_obj.number|default:1 }}">Next</a>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <div class="card-title">Skipped</div>
                  </div>
                  <div class="card-body">
                    <table class="import-preview">
                      <thead>
                        <tr>
                          <th>Row</th>
                          <th></th>
                          {% for field in result.diff_headers %}
                            <th>{{ field }}</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        {% for row in skipped_page_obj %}
                          <tr class="{{ row.import_type }}">
                            <td>{{ row.astra_row_number }}</td>
                            <td class="import-type">
                              {% if row.import_type == 'new' %}
                                New
                              {% elif row.import_type == 'skip' %}
                                Skipped
                              {% elif row.import_type == 'delete' %}
                                Delete
                              {% elif row.import_type == 'update' %}
                                Update
                              {% endif %}
                            </td>
                            {% for field in row.diff %}
                              <td>{{ field }}</td>
                            {% endfor %}
                          </tr>
                        {% empty %}
                          <tr>
                            <td colspan="{{ result.diff_headers|length|add:2 }}">No skipped rows.</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>

                    {% if skipped_page_obj and skipped_page_obj.paginator.num_pages|default:0 > 1 %}
                      <div class="paginator">
                        {% if skipped_page_obj.has_previous %}
                          <a class="js-preview-page-link" href="?matches_page={{ matches_page_obj.number|default:1 }}&skipped_page={{ skipped_page_obj.previous_page_number }}">Previous</a>
                        {% endif %}
                        <span>Page {{ skipped_page_obj.number }} of {{ skipped_page_obj.paginator.num_pages }}</span>
                        {% if skipped_page_obj.has_next %}
                          <a class="js-preview-page-link" href="?matches_page={{ matches_page_obj.number|default:1 }}&skipped_page={{ skipped_page_obj.next_page_number }}">Next</a>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% endif %}
      </form>
    {% else %}
      <form action="" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row">
          <div class="col-12 col-lg-9">
            <div class="card">
              <div class="card-header">
                <div class="card-title">{% trans 'Confirm Import' %}</div>
              </div>
              <div class="card-body">
                {% for field in form %}
                  {% if field.is_hidden %}
                    {{ field }}
                  {% elif field.name == "import_file" %}
                    <div class="form-group field-name">
                      <div class="row">
                        {{ field.errors }}
                        <div class="col-sm-2 text-left">{{ field.label_tag }}</div>
                        <div class="col-sm-10 text-left">
                          {{ field }}
                          <div id="csv-header-preview" class="help mt-1" style="display: none;">
                            <strong>Detected CSV headers:</strong>
                            <span id="csv-header-preview-items"></span>
                          </div>
                        </div>
                        <div class="help-block red">
                          {% if field.field.help_text %}
                            {{ field.field.help_text|safe }}
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <div class="form-group field-name{% if field.name|slice:'-7:' == '_column' %} js-column-selector-row{% endif %}"{% if field.name|slice:'-7:' == '_column' %} style="display: none;"{% endif %}>
                      <div class="row">
                        {{ field.errors }}
                        <div class="col-sm-2 text-left">{{ field.label_tag }}</div>
                        <div class="col-sm-10 text-left">{{ field }}</div>
                        <div class="help-block red">
                          {% if field.field.help_text %}
                            {{ field.field.help_text|safe }}
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
                {% include "admin/core/_membership_csv_import_additional_info.html" %}
                {% if fields %}
                  <p>
                    <b>{% trans "This importer will import the following fields: " %}</b>
                    <ul>
                      {% for field in fields %}
                        <li>{{ field }}</li>
                      {% endfor %}
                    </ul>
                  </p>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-edit"></i>
                  {% trans 'Actions' %}
                </h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <input type="submit" class="btn {{ jazzmin_ui.button_classes.success }} form-control" name="confirm" value="{% trans 'Submit' %}" title="Submit import request">
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    {% endif %}
  </div>
{% endblock %}
